{% extends 'base.html' %}
{% block page_title %} {{block.super}} Manage Reports{% endblock page_title %}

{% load static %}
{% load app_filters %}

{% block style_code %}
<link href="{% static 'plugins/datatables/css/data-table.css' %}" rel="stylesheet" />
{% endblock style_code %}

{% block primary%}
<h1 class="page-header">Manage Reports</h1><small></small>

{% if messages %}
<div id="messages" class="alert alert-danger fade in">
    <span class="close" data-dismiss="alert">Ã—</span>
    <i class="fa fa-check fa-2x pull-left"></i>
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.error %} class="{{ message.danger }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- begin row -->
<div class="row">
    <!-- begin col-2 -->
    <div class="col-md-2">
        <h5>
            Key features include:
        </h5>
        <ul class="p-l-25 m-b-15">
            <li>Download your earlier generated reports and templates</li>
            <li>View reports and templates generated by other staff in your Org unit</li>
            <li>Ability to view existing reports and templates</li>
            <li>Delete your earlier generated reports and templates.</li>
        </ul>
        <p class="m-b-20">
            <a href="{% url 'manage_dashboard' %}" class="btn btn-inverse btn-sm">View my Dashboard</a>
        </p>
        <p class="m-b-20">
            <a href="#" class="btn btn-danger btn-sm">Disk Usage {{ fusage }}</a>
        </p>
    </div>
    <!-- end col-2 -->
    <!-- begin col-10 -->
    <div class="col-md-10">
        <!-- begin panel -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-danger" data-click="panel-remove"><i class="fa fa-times"></i></a>
                </div>
                <h4 class="panel-title">Created Reports and Templates</h4>
            </div>
            <div class="alert alert-warning fade in">
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div id="mng_messages">
                These are reports and templates generated by users and temporarily saved on the server for easier download. <br/>You can manage your own or your Organisation Unit reports from here:
                </div>
            </div>
            <div class="panel-body">
                <form id="manage-rpts">
                    {% csrf_token %}
                </form>
                <div class="table-responsive">
                    <table id="data-table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Report Type</th>
                                <th>Created by</th>
                                <th>Region</th>
                                <th>Period</th>
                                <th>Create datetime</th>
                                <th>Size(KB)</th>
                                <th width="15%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for val in data %}
                                <tr class="odd gradeX" id="report_{{ val.rid }}">
                                    <td>{{ val.rcount }}</td>
                                    <td>{{ val.rtype }} ({{ val.ftype }})</td>
                                    <td>{{ val.rby|gen_value:vals }}</td>
                                    <td>{{ val.rarea }}</td>
                                    <td>{{ val.rperiod }}</td>
                                    <td>{{ val.rcreate }}</td>
                                    <td>{{ val.fsize }}</td>
                                    <td>
                                    <a href='{% url "download_reports" file_name=val.rname %}'>
                                    <button type="button" class="btn btn-success"><i class="fa fa-download"></i></button></a>
                                    <button id = "{{ val.rid }}" rel="{{ val.rname }}" type="button" class="btn btn-danger remove_file"><i class="fa fa-trash-o"></i></button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- end panel -->
    </div>
    <!-- end col-10 -->
</div>
<!-- end row -->

{% endblock primary%}

{% block lazy_javascript_code %}
<script src="{% static 'plugins/datatables/js/jquery.dataTables.js' %}"></script>
<script src="{% static 'plugins/datatables/js/dataTables.colVis.js' %}"></script>

<script type="text/javascript">
var handleDataTableColVis = function() {
    "use strict";
    
    if ($('#data-table').length !== 0) {
        $('#data-table').DataTable({
            dom: 'C<"clear">lfrtip'
        });
    }
};

var TableManageColVis = function () {
    "use strict";
    return {
        //main function
        init: function () {
            handleDataTableColVis();
        }
    };
}();
$(document).ready(function() {
    TableManageColVis.init();

    $("#data-table").delegate(".remove_file", "click", function() {
        var id = $(this).attr('id');
        var fid = $(this).attr('rel');
       // Remove this file from the computer
       $.ajax({
           type: "POST",
           url: "{% url 'manage_reports' %}",
           data: $("#manage-rpts").serialize()+ "&report_id="+ fid,
           success: function(response)
           {
               var msg = response.msg;
               var status_id = response.status;
               if (status_id == 0){
                   $("#report_"+ id).remove();
               }
               $('#mng_messages').html(msg);
           },
            error: function(){
                $('#mng_messages').html("Error removing report")
            }
         });

    });
});
</script>
{% endblock lazy_javascript_code %}
